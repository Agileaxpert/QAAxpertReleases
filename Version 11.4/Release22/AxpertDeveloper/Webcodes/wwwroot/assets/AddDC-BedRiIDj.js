import{r as c,A as je,a as ke,b as _e,u as we,c as ve,j as e,S as Ce,p as Se,e as De,g as Ee,M as X,C as Z,D as Te,q as Oe,h as k,k as E,n as Ae}from"./index-B2g4VXxV.js";const Me=()=>{let{metadataMaster:N,setMetadataMaster:L,getMenuChildren:ee,expandedKeys:te,setExpandedKeys:se,SaveInProgList:ae,setSaveInProgList:I,changedStructList:le,setChangedStructList:Fe,changedCompList:re,structSaveErrorList:Re,setStructSaveErrorList:B,proj:_,UserName:w,sessionKey:oe,showLog:ie,baseURL:v,activeFormDetails:Le,setActiveFormDetails:ne,toast:u,formdata:t,setFormData:M,handleFieldChange:n,isFormDirty:ce,setIsFormDirty:T,beforeFormSubmit:me}=c.useContext(je);const[b,O]=c.useState(!0),[C,P]=c.useState(!0),[S,$]=c.useState(!0),[A,q]=c.useState([]),[G,J]=c.useState(""),[de,z]=c.useState(!1),[U,K]=c.useState(!1),[pe,F]=c.useState(!1),[ue,D]=c.useState(!1),s=ke().state;_e();const he=we(),j={name:"",caption:"",oldCaption:"",dcNo:"",tableName:"",dltOldTbl:"no",asGrid:!1,allowEdit:!0,allowEmpty:!0,allowAdd:!0,allowDelete:!1,booleanDC:!1,defBoolDC:"expand",purpose:"",popup:!1};let R=c.useRef(),V=c.useRef(),Y=c.useRef(),H=c.useRef(),Q=c.useRef(!0);c.useLayoutEffect(()=>{if(!b)if(Q.current){const a=document.getElementsByClassName("section_label"),l=[];for(let i of a)l.push(i.innerText);q(l),Q.current=!1}else{const a=document.getElementsByClassName("section_label"),l=[];for(let i of a)l.push(i.innerText);q(l)}},[t,b]);const fe=a=>{if(a==="Main")return V;if(a==="Options")return Y};c.useEffect(()=>{K(!1),O(!0),P(!0),$(!0),F(!1),D(!1);const a=async()=>{var x;let l=[];const i=N.find(m=>m.key===s.structkey);i!=null&&i.children?l=(x=N.find(m=>m.key===k("tstruct",s.structname,"")))==null?void 0:x.children:l=await ee(i);const r=l==null?void 0:l.filter(m=>(m==null?void 0:m.comp)=="dc");let f,g;r.length>0?g=Math.max(...r.map(m=>parseInt(m.compname.slice(2)))):g=0,f=`dc${g+1}`;let h=s.structname+(g+1);j.dcNo=g+1,j.name=f,j.caption=f,j.tableName=h,J(h),M(j),O(!1)};T(s.mode=="new"),z(!1),ne(s),s.mode=="edit"?(async()=>{const l=new URL(`${v}/GetData/form`);l.searchParams.append("projname",_),l.searchParams.append("username",w),l.searchParams.append("structType","tstruct"),l.searchParams.append("structName",s.structname),l.searchParams.append("compName",s.compname);try{const i=await fetch(l,{method:"POST"});if(i.ok){const r=await i.json();if(r.status!="failure"){r.status=="locked"&&(u.current.show({severity:"warn",summary:"warning",detail:r.message}),K(r.status=="locked"));let f=JSON.parse(r.result);f.oldcaption=f.caption,J(f.tableName),M(f),O(!1)}else u.current.show({severity:"error",summary:"Error!",detail:"Record not found."})}else i.status===404?u.current.show({severity:"error",summary:"Error!",detail:"Record not found."}):u.current.show({severity:"error",summary:"Error!",detail:i.statusText})}catch(i){u.current.show({severity:"error",summary:"Error!",detail:i})}})():setTimeout(()=>{a()},0)},[s]),c.useEffect(()=>{if(!b)if(U)ve("right-panel");else{const a=R.current.querySelector("input:not([readonly]):not([disabled]), textarea:not([readonly]):not([disabled]), select:not([readonly]):not([disabled])");a&&a.focus()}},[b]);const Ne=async()=>{var f,g;T(!1);let a="";const l=k("tstruct",s.structname,t.name);if(!(t.caption==""?(a="Caption can not be empty",!1):t.tableName!==G&&t.dltOldTbl===""?(a="Please select if the old table should be deleted or not",!1):!0))T(!0),u.current.show({severity:"error",summary:"Error!",detail:a});else{var r=`${v}♠${w}♠${l}`;me(l,r,s,t);const h=N.findIndex(o=>o.key===s.structkey);let x=0,m=1;if(h!==-1){if(s.mode==="new"){const o=(f=N[h].children)==null?void 0:f.filter(p=>(p==null?void 0:p.comp)=="dc");m=parseInt(s.ordno?s.ordno:o!=null&&o.length?(o==null?void 0:o.length)+1:1);const d=[...N];s.ordno&&(d[h].children=d[h].children.map(p=>{if(p.comp=="dc"&&parseInt(p.ordno)>=m){const W=parseInt(p.ordno)+1;p.ordno=W.toString(),p.title=e.jsx(E,{node:{...p,ordno:W.toString()}})}return p}));const y={key:l,title:e.jsx(E,{node:{structtype:"tstruct",structname:s.structname,structcaption:s.structcaption,comp:"dc",compname:t.name,compcaption:t.caption,ordno:m.toString()}}),isLeaf:!1,ordno:m.toString(),structtype:"tstruct",structname:s.structname,structcaption:s.structcaption,comp:"dc",compname:t.name,compcaption:t.caption,asgrid:t.asGrid,tablename:t.tableName,icon:e.jsx(Ae,{}),className:"dropAtNode",children:[]};d[h].children.splice(m-1,0,{...y,title:e.jsx(E,{node:y})}),L(d),N[h].children,!te.includes(s.structkey)&&se(p=>[...p,s.structkey])}else if(x=(g=N[h].children)==null?void 0:g.findIndex(o=>o.key===l),x!==-1){m=N[h].children[x].ordno;const o={...N[h].children[x],compcaption:t.caption,asgrid:t.asGrid,tablename:t.tableName,title:e.jsx(E,{node:{...N[h].children[x],compcaption:t.caption,asgrid:t.asGrid,tablename:t.tableName}})},d=[...N];d[h].children[x]=o,L(d)}}let ye={compName:t.name,comp:"dc",compCaption:t.caption,ordNo:m.toString(),DcName:"NA",asGrid:t.asGrid,tableName:t.tableName,isInsert:!!s.ordno},be={mode:s.mode,projName:_,userName:w,sessionID:oe,trace:ie,structName:s.structname,structCaption:s.structcaption,structType:"tstruct",isComp:!0,compJSON:JSON.stringify(ye),propvalJSON:JSON.stringify(t)};await fetch(`${v}/SaveFormData`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(be)}).then(o=>o.ok?o.json():o.json().then(d=>{throw new Error(d)})).then(async o=>{if(o.success){I(y=>y.filter(p=>p!==l)),localStorage.removeItem(r);var d=`${t.caption} (${t.name}) created successfully.`;s.mode=="edit"&&(d=`${t.caption} (${t.name}) saved successfully.`),u.current.show({severity:"success",summary:"success",detail:d}),(s.mode=="new"||s.compname=="dc1"&&s.isfirstTimeLoad)&&z(!0)}else throw new Error(o.message)}).catch(o=>{o.message=="Session authentication failed."?(u.current.show({severity:"error",summary:"Error!",detail:"Session expired!"}),he("/logout")):(I(d=>d.filter(y=>y!==l)),B[l]==null&&B(d=>[...d,l]),u.current.show({severity:"error",summary:"Error!",detail:"Error while saving data!"}))})}},xe=()=>{const a=k("tstruct",s.structname,t.name);return s.isfirstTimeLoad?!0:!U&&ce?!(s.mode=="edit"&&ae.includes(a)):!1},ge=async a=>{var l;if(console.log(a.target.value),s.compname=="dc1"&&s.isfirstTimeLoad){n(a);return}if(s.mode==="edit"&&le[k(s.structtype,s.structname)]!="new"){if(((l=re[k(s.structtype,s.structname)])==null?void 0:l[`axdc♠${t.name}`])=="new"){n(a);return}if(pe)ue?!u.current.getElement().getElementsByClassName("p-toast-detail").length&&u.current.show({severity:"error",summary:"Error!",detail:"Data already exist. Use the Axpert Utility to change the table name."}):n(a);else{const i={userName:w,projName:_,gloStructFilter:"tstruct",sql:`select count(*) as rcount from ${t.tableName}`,sqlParamJSON:JSON.stringify({schema:_})};return await fetch(`${v}/GetData/sql`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(r=>{if(r.ok)return r.json();throw new Error("Unable to fetch data!")}).then(r=>{if(r.success)console.log(a.target.value),JSON.parse(r.data)[0].rcount>0?(D(!0),!u.current.getElement().getElementsByClassName("p-toast-detail").length&&u.current.show({severity:"error",summary:"Error!",detail:"Data already exist. Use the Axpert Utility to change the table name."})):(D(!1),n(a)),F(!0);else if(r.message.includes("does not exist"))D(!1),n(a),F(!0);else throw new Error(r.message)}).catch(r=>{console.log(r),u.current.show({severity:"error",summary:"Error!",detail:"Exception while checking table data."})})}}else n(a)};return b?e.jsx(Ce,{}):de?e.jsx(Se,{caption:"insert",isOpen:!0,showFormelemts:!1,formDetails:{structkey:s.structkey,structname:s.structname,structcaption:s.structcaption,structtype:"tstruct",mode:"new",dcname:t.name||s.compname,dccaption:t.caption||s.compcaption,asgrid:t.asGrid}}):e.jsx(e.Fragment,{children:Object.keys(t).length===0?e.jsx("div",{}):e.jsxs("div",{className:"proplist_wrapper",ref:R,children:[e.jsx(De,{title:Ee(t.name,t.caption),path:`Tstructs(${s.structcaption}) / DC`,type:"dc"}),e.jsxs("div",{id:"quickLinks",className:"",children:[e.jsx("button",{onClick:()=>R.current.scrollIntoView({behavior:"smooth"}),className:"p-2",children:"Top"}),A==null?void 0:A.map(a=>e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"separator",children:"."}),e.jsx("button",{onClick:l=>{document.querySelectorAll(".quicklinks_button").forEach(r=>r.classList.remove("quicklinks_active_button")),l.currentTarget.classList.add("quicklinks_active_button"),fe(a).current.scrollIntoView({behavior:"smooth"})},className:"quicklinks_button p-2",children:a})]})),e.jsx("span",{className:"separator",children:"."}),e.jsx("button",{onClick:()=>H.current.scrollIntoView({behavior:"smooth"}),className:"p-2",children:"Bottom"})]}),e.jsx("div",{className:"proplist_body",children:e.jsxs("form",{children:[e.jsx("div",{className:"proplist_label",ref:V,children:e.jsxs("a",{role:"button",onClick:()=>P(!C),"aria-expanded":C,"aria-controls":"proplist_collapse_main",className:"d-flex align-items-center",children:[e.jsx(X,{className:"me-2 collapse_icon",style:{transform:C?"":"rotate(180deg)"}}),e.jsx("label",{className:"section_label",children:"Main"})]})}),e.jsx("div",{className:"proplist_division ",id:"proplist_main",children:e.jsx(Z,{in:C,children:e.jsxs("div",{id:"proplist_collapse_main",className:"proplist_collapse",children:[e.jsxs("ul",{className:"list-group list-group-horizontal proplist_group",children:[e.jsxs("li",{className:"list-group-item  proplist_item  proplist_key",children:["Name & Caption ",e.jsx("span",{className:"requiredTag",children:"*"})]}),e.jsxs("li",{className:"list-group-item  proplist_item proplist_value flex-nowrap",children:[e.jsx("input",{className:"form-control form-control-sm proplist_formcontrol",id:"inpName",name:"name",value:t.name=="_ _"?"":t.name,onChange:n,type:"text","aria-label":"Name",placeholder:"Enter Name",readOnly:!0}),e.jsx("input",{className:"form-control form-control-sm proplist_formcontrol",id:"inpCaption",name:"caption",value:t.caption=="_ _"?"":t.caption,onChange:n,type:"text",maxLength:100,"aria-label":"caption",placeholder:"Enter Caption"}),e.jsx("input",{type:"hidden",name:"dcNo",value:t.dcNo})]})]}),e.jsxs("ul",{className:"list-group list-group-horizontal proplist_group",children:[e.jsx("li",{className:"list-group-item  proplist_item  proplist_key",children:"Table Name"}),e.jsx("li",{className:"list-group-item  proplist_item proplist_value flex-nowrap",children:e.jsx("input",{className:"form-control form-control-sm proplist_formcontrol",id:"inpTblName",name:"tableName",value:t.tableName,onChange:a=>{ge(a)},type:"text","aria-label":"Table Name"})})]}),s.mode==="edit"&&t.tableName!==G&&e.jsxs("ul",{className:"list-group list-group-horizontal proplist_group",children:[e.jsxs("li",{className:"list-group-item  proplist_item  proplist_key",children:["Delete old table ? ",e.jsx("span",{className:"requiredTag",children:"*"})]}),e.jsxs("li",{className:"list-group-item  proplist_item proplist_value ",children:[e.jsxs("div",{className:"form-check form-check-inline",children:[e.jsx("input",{className:"form-check-input proplist_formcontrol",name:"dltOldTbl",id:"RdoYes",value:"yes",checked:t.dltOldTbl==="yes",onChange:n,type:"radio","aria-label":"Delete old table - Yes ?"}),e.jsx("label",{className:"form-check-label",htmlFor:"RdoYes",children:"Yes"})]}),e.jsxs("div",{className:"form-check form-check-inline",children:[e.jsx("input",{className:"form-check-input proplist_formcontrol",name:"dltOldTbl",id:"RdoNo",value:"no",checked:t.dltOldTbl==="no",onChange:n,type:"radio","aria-label":"Delete old table - No ?"}),e.jsx("label",{className:"form-check-label",htmlFor:"RdoNo",children:"No"})]})]})]}),e.jsxs("ul",{className:"list-group list-group-horizontal proplist_group",children:[e.jsx("li",{className:"list-group-item  proplist_item  proplist_key",children:"As grid"}),e.jsx("li",{className:"list-group-item  proplist_item proplist_value flex-nowrap",children:e.jsx("div",{className:"form-check form-switch",children:e.jsx("input",{className:"form-check-input  proplist_formcontrol",type:"checkbox",value:t.asGrid,id:"chkAsGrid",name:"asGrid",onChange:a=>{n(a)},checked:t.asGrid===!0,disabled:t.name==="dc1"})})})]})]})})}),e.jsx("div",{className:"proplist_label",ref:Y,children:e.jsxs("a",{role:"button",onClick:()=>$(!S),"aria-expanded":S,"aria-controls":"proplist_collapse_options",className:"d-flex align-items-center",children:[e.jsx(X,{className:"me-2 collapse_icon",style:{transform:S?"":"rotate(180deg)"}}),e.jsx("label",{className:"section_label",children:"Options"})]})}),e.jsx("div",{className:"proplist_division ",id:"proplist_options",children:e.jsx(Z,{in:S,children:e.jsxs("div",{id:"proplist_collapse_options",className:"proplist_collapse",children:[e.jsxs("ul",{className:"list-group list-group-horizontal proplist_group",children:[e.jsx("li",{className:"list-group-item  proplist_item  proplist_key "}),e.jsxs("li",{className:"list-group-item  proplist_item proplist_value",children:[e.jsxs("div",{className:"form-check ",children:[e.jsx("input",{className:"form-check-input proplist_formcontrol",type:"checkbox",value:t.allowEdit,id:"chkAlwEdit",name:"allowEdit",onChange:n,checked:t.allowEdit===!0}),e.jsx("label",{className:"form-check-label",htmlFor:"chkAlwEmpty",children:"Allow Edit"})]}),e.jsxs("div",{className:"form-check ",children:[e.jsx("input",{className:"form-check-input proplist_formcontrol",type:"checkbox",value:t.allowEmpty,id:"chkAlwEmpty",name:"allowEmpty",onChange:n,checked:t.allowEmpty===!0}),e.jsx("label",{className:"form-check-label",htmlFor:"chkAlwEmpty",children:"Allow Empty"})]}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input proplist_formcontrol",type:"checkbox",value:t.allowAdd,id:"chkAlwAdd",name:"allowAdd",onChange:n,checked:t.allowAdd===!0,disabled:t.name==="dc1"}),e.jsx("label",{className:"form-check-label",htmlFor:"chkAlwAdd",children:"Add DC Rows"})]}),e.jsxs("div",{className:"form-check ",children:[e.jsx("input",{className:"form-check-input proplist_formcontrol",type:"checkbox",value:t.allowDelete,id:"chkAlwDel",name:"allowDelete",onChange:n,checked:t.allowDelete===!0,disabled:t.name==="dc1"}),e.jsx("label",{className:"form-check-label",htmlFor:"chkAlwDlt",children:"Delete DC Rows"})]}),t.name!=="dc1"&&e.jsxs("div",{className:"form-check ",children:[e.jsx("input",{className:"form-check-input proplist_formcontrol",type:"checkbox",value:t.booleanDC,id:"chkBoolDC",name:"booleanDC",onChange:n,checked:t.booleanDC===!0}),e.jsx("label",{className:"form-check-label",htmlFor:"chkBoolDC",children:"Boolean DC"})]})]})]}),t.booleanDC&&e.jsxs("ul",{className:"list-group list-group-horizontal proplist_group",children:[e.jsx("li",{className:"list-group-item  proplist_item  proplist_key ",children:"Default state for Boolean DC"}),e.jsx("li",{className:"list-group-item  proplist_item proplist_value ",children:e.jsx(Te,{name:"defBoolDC",value:t.defBoolDC,onChange:n,options:Oe,optionLabel:"caption",optionValue:"name",placeholder:"-- select --",showClear:!0,id:"seldefBoolDC",className:"proplist_formcontrol",ariaLabel:"Default state for Boolean DC"})})]})]})})}),e.jsx("div",{className:"proplist_division mt-4",ref:H,children:e.jsx("div",{id:"proplist_collapse_options",className:"proplist_collapse",children:e.jsxs("ul",{className:"list-group list-group-horizontal proplist_group",children:[e.jsx("li",{className:"list-group-item  proplist_item proplist_key",children:"Purpose"}),e.jsx("li",{className:"list-group-item  proplist_item proplist_value ",children:e.jsx("div",{className:" w-100",children:e.jsx("textarea",{className:"form-control proplist_formcontrol w-100",id:"txtPurpose",name:"purpose",rows:"3",maxLength:4e3,value:t.purpose,onChange:n})})})]})})}),e.jsx("button",{type:"button",onClick:Ne,className:"btn btn-primary btnSubmit",...xe()?{}:{disabled:!0},children:"Submit"})]})})]})})};export{Me as default};
